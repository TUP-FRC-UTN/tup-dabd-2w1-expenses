<section class="pt-2"></section>
    <div class="container mt-5 p-2 border border-2 rounded shadow-lg sticky-section">
  
      <!-- Fila de botones de filtro -->
      <div class="row mb-3">
        <!-- Filtro de fechas -->
        <div class="col d-flex gap-3">
          <div class="col">
            <input (change)="filterDataOnChange()" [(ngModel)]="dateFrom" class="form-control" type="date">
          </div>
          <div class="col">
            <input (change)="filterDataOnChange()" [(ngModel)]="dateTo" class="form-control" type="date">
          </div>
  
        </div>
        <!-- Botones de exportar -->
        <div class="col-auto d-flex gap-1 ms-auto">
          <button  class="btn btn-primary filterbutton" data-bs-toggle="modal" title="Filtros Avanzados" data-bs-target="#filtrosAvanzados">
            <i class="bi bi-funnel-fill"></i>
      </button>
      <button type="button" class="btn btn-secondary bi bi-trash filterbutton" title="Limpiar Filtros" (click)="clearFiltered()"></button>
          
        </div>
      </div>
    </div>

  <section class="pt-1">
    <div class="container p-3 border border-2 rounded shadow-lg">
  
      @if (cardView==0) {
        <div class="row">
          <div class="col-5">
            <div class="card border-0 shadow-lg  rounded-4">
              <div class="card-body">
                <h4 class="card-title align-items-center">Gastos del Período <button type="button" class="btn btn-sm btn-link text-muted bi bi-info-circle fs-5 float-end" title="Expandir" (click)="changeView(1)"></button></h4>
                
                <hr>
                <div class="row justify-content-center text-center align-items-center">
                  <div class="col-5 mb-1">
                    <app-expenses-kpi [amount]="amountCommon+amountExtraordinary
                    +amountIndividual+amountNoteCredit" title="Total" 
                    [customStyles]="{ 'background-color': '#fcc7ccde' }" [icon]="'bi bi-cash'"
                    [formatPipe]="'currency'"
                    ></app-expenses-kpi>
                  </div>
                  @if (chartExpensesPeriod.data.length>0) {
                    <div class="col-12 hover-scale flex-grow-1 d-flex align-items-center justify-content-center">
                      <google-chart [type]="chartExpensesPeriod.type" [data]="chartExpensesPeriod.data" [options]="chartExpensesPeriod.options" style="width: 100%; height: auto;"></google-chart>
                    </div>
                  }
                  
                </div>                
              </div>
              
            </div>
            <div class="card border-0 shadow-lg  rounded-4 mt-3">
              <div class="card-body">
                <h4 class="card-title align-items-center">Ultimo Período Facturado <button type="button" class="btn btn-sm btn-link text-muted bi bi-info-circle fs-5 float-end" title="Expandir" (click)="changeView(2)"></button></h4>
                @if(lastBillRecord && lastBillRecord.id>0){
                  <div class="card-subtitle">Desde {{lastBillRecord.start_date | date: 'dd/MM/yyyy'}} Hasta: {{lastBillRecord.end_date | date: 'dd/MM/yyyy'}} </div>
                }
                
                <hr>
                <div class="row justify-content-center text-center align-items-center">
                  <div class="col-5 mb-1">
                    <app-expenses-kpi [amount]="lastBillCommon+lastBillExtraordinary 
                    +lastBillIndividual+lastBillNoteCredit" title="Total" [formatPipe]="'currency'" [customStyles]="{ 'background-color': '#d8ffedde' }" [icon]="'bi bi-cash'"></app-expenses-kpi>
                  </div>
                  @if (chartLastBill.data.length>0) {
                    <div class="col-12 hover-scale flex-grow-1 d-flex  align-items-center justify-content-center">
                      <google-chart [type]="chartLastBill.type" [data]="chartLastBill.data" [options]="chartLastBill.options" style="width: 100%; height: auto;"></google-chart>
                    </div>
                   }
                </div>
              </div>
            </div>
          </div>
          <div class="col-7">
            <div class="card h-100 border-0 shadow-lg  rounded-4">
              <div class="card-body d-flex flex-column">
                <h4 class="card-title align-items-center">{{titleCard}} <button type="button" class="btn btn-sm btn-link text-muted bi bi-info-circle fs-5 float-end" title="Expandir" (click)="changeView(3)"></button></h4>
                <hr>
                <div class="row">
                  <div class="col-4">
                    <app-expenses-kpi [amount]="amountLastYear" [title]="titleLAstYear" [formatPipe]="'currency'" [customStyles]="{ 'background-color': '#fcc7ccde' }" [icon]="'bi bi-cash'"></app-expenses-kpi>
                  </div>
                  <div class="col-4">
                    <app-expenses-kpi [amount]="amountThisYear" [title]="titleThisYear" [formatPipe]="'currency'" [customStyles]="{ 'background-color': '#fcc7ccde' }" [icon]="'bi bi-cash'"></app-expenses-kpi>
                  </div>
                  <div class="col-4">
                    @if (percentageVariation>=0) {
                      <app-expenses-kpi [amount]="percentageVariation" [title]="'Aumento Gasto'" [formatPipe]="'percent'" [customStyles]="{ 'background-color': '#fcc7ccde' }" [icon]="'bi bi-arrow-up-short'"></app-expenses-kpi>
                    }@else {
                      <app-expenses-kpi [amount]="percentageVariation * -1" [title]="'Reduccion Gasto'" [formatPipe]="'percent'" [customStyles]="{ 'background-color': '#d8ffedde' }" [icon]="'bi bi-arrow-down-short'"></app-expenses-kpi>
                    }
                  </div>
                </div>
                @if (chartCompareYearMonth.data.length>0 && chartCompareYearMonth.columns.length>0) {
                  <div class="hover-scale flex-grow-1 d-flex justify-content-center align-items-center">
                    <google-chart [type]="chartCompareYearMonth.type" [columns]="chartCompareYearMonth.columns" 
                  [data]="chartCompareYearMonth.data" [options]="chartCompareYearMonth.options" style="width: 100%; height:100%;">
                </google-chart>
                  </div>              
                  }
                
              </div>
            </div>
          </div>
        </div>
      }
      @if (cardView==1) {
        <div class="row">
          <div class="col-12">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <h4 class="card-title">Gastos del Período</h4>
                <hr>
                <div class="row">
                  <div class="col-12">
                    <div class="row justify-content-center text-center align-items-center">
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="amountCommon+amountExtraordinary
                        +amountIndividual+amountNoteCredit" title="Total"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="amountCommon" title="Comunes"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi  [amount]="amountExtraordinary" title="Extraordinarios"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="amountIndividual" title="Individuales"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi  [amount]="amountNoteCredit" title="Nota de Crédito"></app-expenses-kpi>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row flex-grow-1 d-flex justify-content-center align-items-center mt-1 hover-scale">
                  @if (chartExpensesPeriod.data.length>0) {
                    <div class="col-12 col-xl-5 d-flex align-items-center justify-content-center">
                      <google-chart [type]="chartExpensesPeriod.type" [data]="chartExpensesPeriod.data" [options]="chartExpensesPeriod.options"></google-chart>
                    </div>
                  }
                </div>
                
              </div>
              
            </div>
          </div>
        </div>
      }
      @if (cardView==2){
        <div class="row">
          <div class="col-12 col-lg-6">
            <div class="card mt-1 mt-lg-0">
              <div class="card-body">
                <h4 class="card-title">Ultimo Período Facturado</h4>
                @if(lastBillRecord && lastBillRecord.id>0){
                  <div class="card-subtitle">Desde {{lastBillRecord.start_date | date: 'dd/MM/yyyy'}} Hasta: {{lastBillRecord.end_date | date: 'dd/MM/yyyy'}} </div>
                }
                
                <hr>
                <div class="row">
                  <div class="col-12">
                    <div class="row justify-content-center text-center align-items-center">
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="lastBillCommon+lastBillExtraordinary
                        +lastBillIndividual+lastBillNoteCredit" title="Total"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1" >
                        <app-expenses-kpi [amount]="lastBillCommon" title="Comunes"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="lastBillExtraordinary" title="Extraordinarios"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="lastBillIndividual" title="Individuales"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        <app-expenses-kpi [amount]="lastBillNoteCredit" title="Nota de Crédito"></app-expenses-kpi>
                      </div>
                      <div class="col-5 m-1">
                        @if(lastBillRecord && lastBillRecord.id>0){
                          <app-expenses-kpi [amount]="lastBillRecord.fineAmount" title="Multas"></app-expenses-kpi>
                        }@else {
                          <app-expenses-kpi [amount]="0" title="Multas"></app-expenses-kpi>
                        }
                        
                      </div>
                      <div class="col-5 m-1">
                        @if(lastBillRecord && lastBillRecord.id>0){
                          <app-expenses-kpi [amount]="lastBillRecord.pendingAmount" title="Pendiente"></app-expenses-kpi>
                        }@else {
                          <app-expenses-kpi [amount]="0" title="Multas"></app-expenses-kpi>
                        }
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row justify-content-center text-center align-items-center mt-1 hover-scale">
                 @if (chartLastBill.data.length>0) {
                  <div class="col-12 col-xl-5 d-flex align-items-center justify-content-center">
                    <google-chart [type]="chartLastBill.type" [data]="chartLastBill.data" [options]="chartLastBill.options"></google-chart>
                  </div>
                 }
                </div>
                
              </div>
            </div>
      </div>
        </div>
      }
      @if (cardView==3) {
        <div class="row justify-content-center align-items-center m-1">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Comparación de Gastos Mensuales entre Años</h4>
              <hr>
              @if (chartCompareYearMonth.data.length>0 && chartCompareYearMonth.columns.length>0) {
                <div class="hover-scale">
                  <google-chart [type]="chartCompareYearMonth.type" [columns]="chartCompareYearMonth.columns" 
                [data]="chartCompareYearMonth.data" [options]="chartCompareYearMonth.options" style="width: 100%; height: 70vh;">
              </google-chart>
                </div>              
                }
              
            </div>
          </div>
        </div>
      }
    </div>
  
  </section>
  <app-expenses-filters 
[(selectedCategories)]="selectedCategories"
[(selectedProviders)]="selectedProviders"
[(selectedTypes)]="selectedType"
 (selectedCategoriesChange)="filteredCharts()" 
 (selectedProvidersChange)="filteredCharts()"
 (selectedTypesChange)="filteredCharts()"
 ></app-expenses-filters>






